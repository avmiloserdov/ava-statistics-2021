# ava-statistics-2

Ветка master содержит скрипты на языке R, выполняющие различные виды анализа данных и обеспечивающие дополнительный функционал на сайте

## Оглавление
* [Описание](#Описание)
* [Оглавление](#Оглавление)
* [Методы анализа данных](#Методы анализа данных)
    * [Корреляционный анализ](#Корреляционный анализ)
    * [Кластерный анализ](#Кластерный анализ)
    * [Метод главных компонент](#PCA Principal component analysis - метод главных компонент)
    * [Факторный анализ](#Факторный анализ)
* [Вспомогательные скрипты](#Вспомогательные скрипты)
    * [Выгрузка частей таблиц](#Выгрузка частей таблиц)
    * [Значение в определенном столбце](#Значение в определенном столбце)
    * [Анализ видового состава](#Анализ видового состава)
    * [Построение графика для количества видов растений определленных групп в датасетах](#Построение графика для количества видов растений определленных групп в датасетах)


## Методы анализа данных

### Корреляционный анализ

Корреляционный анализ — метод обработки статистических данных, с помощью которого измеряется теснота связи между двумя или более переменными.

Для запуска скрипта с входными параметрами необходимо ввести команду в терминале:

` Rscript <название исполняемого скрипта с расширением> <имя файла и путь, если файл находится в другой директории> <номер листа в книге excel> < название первого столбца для анализа> .. <название столбца n для анализа>`


В данном скрипте реализован анализ, использующий метод коррелции Пирсона. 

Работа скрипта: 

 1. считывание аргументов из консоли/термнала (считывание начинается с 6 аргумента, первые 5 заняты системными аргументами)
 
```
 args <- commandArgs()
 print(args)
 n <- as.numeric(args[7])
 df <- openxlsx::read.xlsx(args[6], sheet = n)
```

 2. запускается фильтр пропущенных значений, чтобы анализ дал корректрный результат 
 
` t <-  Filter(function(x)!all(is.na(x)), df)`

 3. проводится анализ по 2 колонкам и выводится результат в терминал
 
```
 a <- cor.test(x=t[[args[8]]], y=t[[args[9]]], meth)
 print(a)
```
 
 Замечание: анализ проводится с численными значениями. 

### Кластерный анализ (коэффициент Жаккара и построение дендрограммы)

Кластерный анализ - многомерная статистическая процедура, выполняющая сбор данных, содержащих информацию о выборке объектов, и затем упорядочивающая объекты в сравнительно однородные группы
Необходимо было реализовать кластерный анализ, используя [коээфициент сходства Жаккара ](https://ru.wikipedia.org/wiki/Коэффициент_Жаккара).

Для запуска скрипта с входными параметрами необходимо ввести команду в терминале

Rscript <название исполняемого скрипта с расширением> <имя файла и путь, если файл находится в другой директории> <номер листа в книге excel> )

Принцип работы скрипта: 

 1. считывание аргументов из консоли/термнала (считывание начинается с 6 аргумента, первые 5 заняты системными аргументами)
 
```
 args <- commandArgs()
 k <- as.numeric(args[7])
 df <- openxlsx::read.xlsx(args[6], sheet = k)
```

 2. удаление первых столбцов и создание названия строк названиеми растений, затем транспонирование таблицы для построение дендрограммы по именам описаний
 
```
 df[,1] <- NULL
 df[,1] <- NULL
 row.names(df) <- df[,1]
 df[,1] <- NULL 
 df <- t(df)
```

 3. Затем создается матрицы сходства и проводится класетрный анализ 
 
```
 d <- vegdist(df, method = "jaccard"); d
 fit <- hclust(d, method = "single")
```

 4. Построение дендрограммы
 
```
 plot(fit, labels=rownames(data), ylab='Jaccard Index', xlab = ' ',cex=0.5, main = 'Cluster dendrogram, Jaccard index')
 abline(h = 0.5)
```
### PCA (Principal component analysis) - метод главных компонент

Применение метода главных компонент позволяет уменьшить размерность данных из ENV таблиц, при этом потеряв минимальное количество информации.

Запуск скрипта производится с помощью консольной команды:

    Rscript <название исполняемого скрипта> <имя файла> <номер листа в книге excel> <кол-во анализируемых столбцов> <название столбца 1> .. <название столбца n>

Пример запуска скрипта:

    Rscript PCA_1.R new_yava_Bovan_ksermokhina_2005_env_fortv_full_header.xlsx 1 6 COV_SHRUBS COV_MOSS COV_LICH COV_TOTAL SHRUB_HT HERB_HT


Первый этап исполнения скрипта - чтение данных из консоли

```
args <- commandArgs()
print(args)
n <- as.numeric(args[7])
data <- read_excel(args[6], sheet = n)
```

Формируется вектор переменных, обращение к конкретной переменной происходит по индексу. Первые 5 переменных являются системными и не используются при анализе. Далее осуществляется подготовка данных к анализу - названия строк заменяются на значения из столбца FIELD_NR:

`data <- column_to_rownames(data, var = colnames(data[2]))`

Третий этап - непосредственный запуск анализа PCA с определенными параметрами:

`data.pca <- prcomp(na.omit(data),scale=TRUE)`

Подробная [документация](https://www.rdocumentation.org/packages/stats/versions/3.6.2/topics/prcomp) метода prcomp. Параметр na.omit обрабатывает пустые значения, а параметр scale = True отвечает за масштабирование выводимых результатов.

Затем с помощью методов print и biplot происходит вывод результатов анализа, при запуске скрипта через консоль автоматически генерируется PDF-файл с названием Rplot

```
print(data.pca)
biplot(data.pca,scale=TRUE,xlim=c(-0.5,0.5))
```

Скрипт корректно работает с численными данными, анализ других типов данных не предусмотрен

### Факторный анализ

Факторный анализ – это многомерная методика, позволяющая изучить взаимосвязи между параметрами переменных. В процессе происходит исследование строения ковариационных или корреляционных матриц.

Процесса запуска скрипта Factor_Test и подготовка данных аналогична PCA и описана выше.

Параметр factors позволяет задать подходящее кол-во факторов. Для корректной работы скрипта при значении параметра, равным двум, рекомендуется брать для анализа 5 и более столбцов с численными данными. С помощью параметра scores задается тип баллов, в данном скрипте задано значение "regression", которое дает [оценки Томпсона](https://ru.qaz.wiki/wiki/Horvitz–Thompson_estimator).

`stick.fa = factanal(na.omit(data), factors = 2, method = "mls", scores = "regression")
stick.fa`

Вывод результатов

Сперва отображается значение уникальности для выбранных переменных. Уникальность - часть дисперсии переменной, объясненной уникальным фактором. Чем выше значение уникальности, тем меньше данная переменная объяснена уникальным фактором.

```
>Uniquenesses:
> COV_SHRUBS   COV_MOSS   COV_LICH  COV_TOTAL   SHRUB_HT    HERB_HT
>      0.439      0.005      0.844      0.677      0.005      0.825 
```

Далее выводится матрица нагрузок Loadings, которая отражает корреляцию переменных и факторов. Чем выше корреляция, тем лучше данная переменная объяснена конкретным фактором.

```
Loadings:
           Factor1 Factor2
COV_SHRUBS  0.727   0.182
COV_MOSS    0.232   0.970
COV_LICH    0.126   0.374
COV_TOTAL   0.250   0.511
SHRUB_HT    0.979   0.191
HERB_HT            -0.418
```

Для интерпретации результатов анализа рекомендуется применять творческие способности. Как и PCA, скрипт для факторного анализа корректно работает с численными данными, анализ других типов данных не предусмотрен.

## Вспомогательные скрипты

### Выгрузка частей таблиц

Данный скрипт был запрошен заказчиком для того, чтобы можно было получать только конкретные части таблиц по определнным критериям. 

Для запуска скрипта с входными параметрами необходимо ввести команду в терминале

Rscript <название исполняемого скрипта с расширением> <имя файла и путь, если файл находится в другой директории> <номер листа в книге excel> <количество элементов выбранных для выгрузки части таблицы> <столбец, в котором будет происходить поиск элементов для выгрузки> <элемент 1> <элемент 2> и т.д.)

Принцип работы скрипта: 
 1. считывание аргументов из консоли/термнала (считывание начинается с 6 аргумента, первые 5 заняты системными аргументами)
 
```
 args <- commandArgs()
 k <- as.numeric(args[7])
 df <- openxlsx::read.xlsx(args[6], sheet = k)
```
 
 2. создание вектора, содержащего все элементы для выгрузки
 
```
 m <- 10 + as.numeric(args[8])
 l <- c()
 for (i in 10:m) {
  l <- append(l,args[i])
```

 3. выгрузка части таблицы по выбранным криетриям и создание файла, содержащего необходимый кусок таблицы
 
```
 df_1 <- subset(df, df[[args[9]]] %in% l)
 print(df_1)
 write.xlsx(df_1, file = "subset.xlsx")
```


### Значение в определенном столбце

В работе возникла необходимость знать все элементы в определнных столбцах.
Для запуска скрипта с входными параметрами необходимо ввести команду в терминале

`Rscript <название исполняемого скрипта с расширением> <имя файла и путь, если файл находится в другой директории> <номер листа в книге excel>`

Принцип работы скрипта: 
 1. считывание аргументов из консоли/термнала (считывание начинается с 6 аргумента, первые 5 заняты системными аргументами)
 
```
 args <- commandArgs()
 k <- as.numeric(args[7])
 df <- openxlsx::read.xlsx(args[6], sheet = k)
```
 
 2. элементы в столбце и вывод их в консоль
 
```
 for (i in df[,1]) {
  print(i)
}
```

Замечение: вместо номера столбца, можно записать args[8] и автоматизировать данный скрипт для любого столбца, однако в нашем случае такой необходимости не было. 

Данный скрипт был использован для двух столбцов. 

### Анализ видового состава

Скрипт classify_by_groups осуществляет анализ видового состава (подсчет количества видов растений, относящихся к тому или иному отделу: мхи, сосудистые, лишайники, печеночники) и выводит результаты в консоль.

Запуск сприпта осуществляется с помощью консольной команды

`Rscript <название исполняемого скрипта с расширением> <имя файла и путь, если файл находится в другой директории> <номер листа в книге excel>`

Считывание аргументов из терминала выполяется аналогично другим скриптам и подробнее описано выше. После считвания аргументов происходит импорт необходимых для работы скрипта таблиц

```
vascularPlants <- read_excel("SPECIES_1_VASCULAR_PLANT.xlsx")
mossPlants <- read_excel("SPECIES_2_MOSS.xlsx")
liverwortPlants <- read_excel("SPECIES_3_LIVERWORT.xlsx")
lichenPlants <- read_excel("SPECIES_4_LICHEN.xlsx")
unknowPlants <- read_excel("SPECIES_5_Unknow.xlsx")
```


Далее из импортированных извлекаются необходимые значения и формируются векторы с названием видов растений

```
plantsFromSppTable <- sppTable$`PASL TAXON SCIENTIFIC NAME NO AUTHOR(S)`
vascular <- vascularPlants$ABBREVIAT
moss <- mossPlants$ABBREVIAT
liverwort <- liverwortPlants$ABBREVIAT
lichen <- lichenPlants$ABBREVIAT
unknow <- unknowPlants$ABBREVIAT
```

Затем с помошью цикла происходит поиск конкретных видов в таблицах SPECIES и подсчет количества видов определенной группы. Если конкретный вид встречается в таблице SPECIES опереденной группы, то увеличивается значение соответствующего счетчика

```
numOfVascular = 0
numOfMoss = 0
numOfLiverwort = 0
numOfLichen = 0
numOfUnknow = 0

for (i in 1:length(plantsFromSppTable)) {
if (plantsFromSppTable[i] %in% vascular == T) numOfVascular = numOfVascular + 1
  else if (plantsFromSppTable[i] %in% moss == T) numOfMoss = numOfMoss + 1
    else if (plantsFromSppTable[i] %in% liverwort == T) numOfLiverwort = numOfLiverwort + 1
     else if (plantsFromSppTable[i] %in% lichen == T) numOfLichen = numOfLichen + 1
      else numOfUnknow = numOfUnknow + 1
  i = i + 1
}
```

После чего в консоль выводятся значения счетчиков, а также общее число видов в датасете. В случае успешной классификации растений появится соотвествующее сообщение: All plants classifed

```
cat(length(plantsFromSppTable), 
    "\n", numOfVascular, 
    "\n", numOfMoss, 
    "\n", numOfLiverwort,
    "\n", numOfLichen,
    "\n", numOfUnknow)

total <- numOfVascular+numOfMoss+numOfLiverwort+numOfLichen+numOfUnknow

if (total == length(plantsFromSppTable)) {
  cat("\nAll plants classifed")
  } else cat("Some plants not classifed")
```

### Построение графика для количества видов растений определленных групп в датасетах

Скрипт charts_for_groups осуществляет построение графика: ось X - названия датасетов, ось Y - количество растенений выбранной группы в датасете

После считывания аргументов из консоли происходит формирование отсортированного по возрастанию вектора speciesRichnessSorted. Для построение графика с значениями по возрастанию необходимо провести дополнительную сортировку, сформировав факторные переменные.

```
speciesRichnessSorted <- speciesRichness[order(as.integer(speciesRichness[[args[8]]]),decreasing = FALSE), ]
speciesRichness$Dataset_name <- factor(speciesRichness$Dataset_name, 
                                       levels = speciesRichness$Dataset_name[order(speciesRichness[args[8]])])
```
Далее с помощью функции ggplot выполняется построение графика, задаются значения для осей, размеры точек, а также поворот подписей значений оси X

```
ggplot(data = speciesRichness,
       mapping = aes(y = speciesRichness[[args[8]]],
                     x = Dataset_name)) +
  geom_point(size=2.5) +
  ylab(args[8]) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
str(speciesRichnessSorted)
```
Результатом исполнения скрипта является файл Rplots

data processing methods
